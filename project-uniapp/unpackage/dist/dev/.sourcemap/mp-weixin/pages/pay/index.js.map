{"version":3,"sources":["uni-app:///main.js","webpack:///D:/work/scan-code-order/project-rjwm-weixin-uniapp-develop-wsy/pages/pay/index.vue?75a7","webpack:///D:/work/scan-code-order/project-rjwm-weixin-uniapp-develop-wsy/pages/pay/index.vue?780b","webpack:///D:/work/scan-code-order/project-rjwm-weixin-uniapp-develop-wsy/pages/pay/index.vue?f682","webpack:///D:/work/scan-code-order/project-rjwm-weixin-uniapp-develop-wsy/pages/pay/index.vue?28b6","uni-app:///pages/pay/index.vue"],"names":["wx","__webpack_require_UNI_MP_PLUGIN__","__webpack_require__","createPage","Page","data","timeout","rocallTime","orderId","orderDataInfo","activeRadio","payMethodList","times","imgUrl","created","mounted","onLoad","methods","open","close","handleChange","console","handleSave","uni","url","clearTimeout","orderNumber","payMethod","res","title","icon","setTimeout","duration","saveQRcode","success","scope","fail","content","confirmText","cancelText","saveQRcodeToPhotosAlbum","fsm","filePath","encoding","that","selectResult","runTimeBack","min","sec"],"mappings":";;;;;;;;;;;;;AAAA;AAGA;AACA;AAHA;AACAA,EAAE,CAACC,iCAAiC,GAAGC,mBAAmB;AAG1DC,UAAU,CAACC,cAAI,CAAC,C;;;;;;;;;;;;;ACLhB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAA8H;AAC9H;AACyD;AACL;AACyD;AACjC;;;AAG5E;AACgM;AAChM,gBAAgB,uMAAU;AAC1B,EAAE,2EAAM;AACR,EAAE,4FAAM;AACR,EAAE,qGAAe;AACjB;AACA;AACA;AACA;AACA;AACA,EAAE,gGAAU;AACZ;AACA;;AAEA;AACe,gF;;;;;;;;;;;;ACxBf;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;;;;;;;;;;;;ACAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA,aAAa,gQAEN;AACP,KAAK;AACL;AACA,aAAa,oPAEN;AACP,KAAK;AACL;AACA,CAAC;AACD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;ACtCA;AAAA;AAAA;AAAA;AAAsuB,CAAgB,ivBAAG,EAAC,C;;;;;;;;;;;;;;;;;;;;;;AC2D1vB;AACA;AAAA;AAAA;AAAA,eACA;EACAC;IACA;MACAC;MACAC;MACAC;MACAC;MACAC;MACAC;MACAC;MACAC;IACA;EACA;EACAC;IACA;EACA;EACAC;IACA;EACA;EACAC;IACA;EACA;EACAC,yCACA;IACA;IACAC;MACA;MACA;IACA;IACA;IACAC;MACA;IACA;IAEAC;MACAC;MACA;IACA;IACA;IACAC;MAAA;MACA;QACA;QACAC;UACAC;QACA;MACA;QACA;QACAC;QACA;UACAC;UACAC;QACA;QACA;UAAA;YAAA;cAAA;gBAAA;kBAAA;oBAAA,MACAC;sBAAA;sBAAA;oBAAA;oBAAA,MACA;sBAAA;sBAAA;oBAAA;oBACA;oBACA;oBACA;oBACA;oBACA;oBACA;oBACA;oBACA;oBACA;oBACA;oBACA;oBACA;oBACA;oBACA;oBACA;oBACA;oBACA;oBACA;oBACA;oBACA;oBACA;oBACA;oBACAP;oBAAA;oBAAA,OACAE;sBAAAM;sBAAAC;oBAAA;kBAAA;oBACAC;sBACA;sBACAR;wBACAC;sBACA;oBACA;oBAAA;oBAAA;kBAAA;oBAEA;oBACA;kBAAA;oBAAA;oBAAA;kBAAA;oBAIAH;oBACAE;sBACAM;sBACAG;sBACAF;oBACA;kBAAA;kBAAA;oBAAA;gBAAA;cAAA;YAAA;UAAA,CAEA;UAAA;YAAA;UAAA;QAAA;MACA;IACA;IACA;IACAG;MAAA;MACAV;QACAW;UACA;YAAA;YACA;UACA;YACAX;cACAY;cACAD;gBACAb;gBACA;cACA;cACAe;gBAAA;gBACAb;kBACAc;kBACAC;kBACAC;kBACAL;oBACA;sBACAX;wBACAW;0BACAb;wBACA;sBACA;oBACA;sBACAA;oBACA;kBACA;gBACA;cACA;YACA;UACA;QACA;MACA;IACA;IAGA;IACAmB;MACA;MACA;MACA;MACA;MACAC;QACAC;QACArC;QACAsC;QACAT;UACAX;YACAmB;YACAR;cACAX;gBACAM;gBACAC;cACA;cACAc;YACA;YACAR;cACAf;YACA;UACA;QACA;MACA;IACA;IAEA;IACAwB;MAAA;MACA;QACA;UACAtB;YAAAM;YAAAC;UAAA;UACAC;YACAR;cACAC;YACA;UACA;QACA;UACAD;YACAM;YACAG;YACAF;UACA;QACA;UACA;UACAP;YACAM;YACAC;UACA;QACA;MACA;IACA;IAIA;IACAgB;MACA;MACA;MACA;MACA;MACA;QACA;QACArB;MACA;QACA;QACA;QACA;UACAsB;QACA;UACAA;QACA;QACA;UACAC;QACA;UACAA;QACA;QACA;QACA;QACA;UACA;YACA;YACAvB;YACA;UACA;UACA;YACAmB;UACA;QACA;MACA;IACA;EAAA;AAEA;AAAA,2B","file":"pages/pay/index.js","sourcesContent":["import 'uni-pages';\n// @ts-ignore\nwx.__webpack_require_UNI_MP_PLUGIN__ = __webpack_require__;\nimport Vue from 'vue'\nimport Page from './pages/pay/index.vue'\ncreatePage(Page)","import { render, staticRenderFns, recyclableRender, components } from \"./index.vue?vue&type=template&id=32f2f1fc&scoped=true&\"\nvar renderjs\nimport script from \"./index.vue?vue&type=script&lang=js&\"\nexport * from \"./index.vue?vue&type=script&lang=js&\"\nimport style0 from \"./../common/Navbar/navbar.scss?vue&type=style&index=0&id=32f2f1fc&lang=scss&scoped=true&\"\nimport style1 from \"./../order/style.scss?vue&type=style&index=1&lang=scss&\"\n\n\n/* normalize component */\nimport normalizer from \"!C:\\\\Users\\\\220408201\\\\Desktop\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\@dcloudio\\\\vue-cli-plugin-uni\\\\packages\\\\vue-loader\\\\lib\\\\runtime\\\\componentNormalizer.js\"\nvar component = normalizer(\n  script,\n  render,\n  staticRenderFns,\n  false,\n  null,\n  \"32f2f1fc\",\n  null,\n  false,\n  components,\n  renderjs\n)\n\ncomponent.options.__file = \"pages/pay/index.vue\"\nexport default component.exports","export * from \"-!C:\\\\Users\\\\220408201\\\\Desktop\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\@dcloudio\\\\vue-cli-plugin-uni\\\\packages\\\\vue-loader\\\\lib\\\\loaders\\\\templateLoader.js??vue-loader-options!C:\\\\Users\\\\220408201\\\\Desktop\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\@dcloudio\\\\vue-cli-plugin-uni\\\\packages\\\\webpack-preprocess-loader\\\\index.js??ref--17-0!C:\\\\Users\\\\220408201\\\\Desktop\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\@dcloudio\\\\webpack-uni-mp-loader\\\\lib\\\\template.js!C:\\\\Users\\\\220408201\\\\Desktop\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\@dcloudio\\\\vue-cli-plugin-uni\\\\packages\\\\webpack-uni-app-loader\\\\page-meta.js!C:\\\\Users\\\\220408201\\\\Desktop\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\@dcloudio\\\\vue-cli-plugin-uni\\\\packages\\\\vue-loader\\\\lib\\\\index.js??vue-loader-options!C:\\\\Users\\\\220408201\\\\Desktop\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\@dcloudio\\\\webpack-uni-mp-loader\\\\lib\\\\style.js!./index.vue?vue&type=template&id=32f2f1fc&scoped=true&\"","var components\ntry {\n  components = {\n    uniPopup: function () {\n      return import(\n        /* webpackChunkName: \"uni_modules/uni-popup/components/uni-popup/uni-popup\" */ \"@/uni_modules/uni-popup/components/uni-popup/uni-popup.vue\"\n      )\n    },\n    uniIcons: function () {\n      return import(\n        /* webpackChunkName: \"components/uni-icons/uni-icons\" */ \"@/components/uni-icons/uni-icons.vue\"\n      )\n    },\n  }\n} catch (e) {\n  if (\n    e.message.indexOf(\"Cannot find module\") !== -1 &&\n    e.message.indexOf(\".vue\") !== -1\n  ) {\n    console.error(e.message)\n    console.error(\"1. 排查组件名称拼写是否正确\")\n    console.error(\n      \"2. 排查组件是否符合 easycom 规范，文档：https://uniapp.dcloud.net.cn/collocation/pages?id=easycom\"\n    )\n    console.error(\n      \"3. 若组件不符合 easycom 规范，需手动引入，并在 components 中注册该组件\"\n    )\n  } else {\n    throw e\n  }\n}\nvar render = function () {\n  var _vm = this\n  var _h = _vm.$createElement\n  var _c = _vm._self._c || _h\n}\nvar recyclableRender = false\nvar staticRenderFns = []\nrender._withStripped = true\n\nexport { render, staticRenderFns, recyclableRender, components }","import mod from \"-!C:\\\\Users\\\\220408201\\\\Desktop\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\babel-loader\\\\lib\\\\index.js!C:\\\\Users\\\\220408201\\\\Desktop\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\@dcloudio\\\\vue-cli-plugin-uni\\\\packages\\\\webpack-preprocess-loader\\\\index.js??ref--13-1!C:\\\\Users\\\\220408201\\\\Desktop\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\@dcloudio\\\\webpack-uni-mp-loader\\\\lib\\\\script.js!C:\\\\Users\\\\220408201\\\\Desktop\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\@dcloudio\\\\vue-cli-plugin-uni\\\\packages\\\\vue-loader\\\\lib\\\\index.js??vue-loader-options!C:\\\\Users\\\\220408201\\\\Desktop\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\@dcloudio\\\\webpack-uni-mp-loader\\\\lib\\\\style.js!./index.vue?vue&type=script&lang=js&\"; export default mod; export * from \"-!C:\\\\Users\\\\220408201\\\\Desktop\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\babel-loader\\\\lib\\\\index.js!C:\\\\Users\\\\220408201\\\\Desktop\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\@dcloudio\\\\vue-cli-plugin-uni\\\\packages\\\\webpack-preprocess-loader\\\\index.js??ref--13-1!C:\\\\Users\\\\220408201\\\\Desktop\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\@dcloudio\\\\webpack-uni-mp-loader\\\\lib\\\\script.js!C:\\\\Users\\\\220408201\\\\Desktop\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\@dcloudio\\\\vue-cli-plugin-uni\\\\packages\\\\vue-loader\\\\lib\\\\index.js??vue-loader-options!C:\\\\Users\\\\220408201\\\\Desktop\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\@dcloudio\\\\webpack-uni-mp-loader\\\\lib\\\\style.js!./index.vue?vue&type=script&lang=js&\"","<!--购买页-->\n<template>\n  <view class=\"customer-box\">\n    <view class=\"wrap\">\n      <view class=\"contion\">\n        <view class=\"orderPay\">\n          <view>\n            <view v-if=\"timeout\">订单已超时</view>\n            <view v-else\n              >支付剩余时间<text>{{ rocallTime }}</text></view\n            >\n          </view>\n          <view class=\"money\"\n            >￥<text>{{ orderDataInfo.orderAmount }}</text></view\n          >\n          <view>订单号-{{ orderDataInfo.orderNumber }}</view>\n        </view>\n      </view>\n      <view class=\"box payBox\">\n        <view class=\"contion\">\n          <view class=\"example-body\">\n            <radio-group class=\"uni-list\" @change=\"handleChange\" >\n              <view class=\"uni-list-item\">\n                <view class=\"uni-list-item__container\" v-for=\"(item,index) in payMethodList\" :key=\"item\">\n                  <view class=\"uni-list-item__content\">\n                    <icon :class=\"'payIcon'+index\"></icon>\n                    <text class=\"uni-list-item__content-title\">{{item}}</text>\n                  </view>\n                  <view class=\"uni-list-item__extra\">\n                    <radio :value=\"index\" color=\"#FFC200\" :checked=\"index === 0\" class=\"radioIcon\" />\n                  </view>\n                </view>\n              </view>\n            </radio-group>\n          </view>\n        </view>\n      </view>\n      <view class=\"bottomBox btnBox\">\n        <button class=\"add_btn\" type=\"primary\" plain=\"true\" @click=\"handleSave\">\n          确认支付\n        </button>\n      </view>\n      \n    </view>\n    <uni-popup ref=\"popup\" type=\"center\" :mask-click=\"false\" class=\"kefu\">\n      <view class=\"popup\">\n        <view class=\"icon-close\">\n          <uni-icons type=\"close\" size=\"30\" @click=\"close\" color=\"#fff\"></uni-icons>\n        </view>\n        <image :src=imgUrl mode=\"widthFix\" class=\"QRcode\"></image>\n        <view class=\"tip\">请保存图片,识别二维码付款</view>\n        <button type=\"warn\" size=\"default\" class=\"btn-savecode\" @click=\"saveQRcode\">保存图片</button>\n        <button type=\"warn\" size=\"default\" class=\"btn-savecode\" @click=\"selectResult\">完成支付</button>\n      </view>\n    </uni-popup>\n  </view>\n</template>\n\n<script>\nimport { mapState } from \"vuex\";\nimport { paymentOrder, cancelOrder,queryOrdersStatus } from \"@/pages/api/api.js\";\nexport default {\n  data() {\n    return {\n      timeout: false,\n      rocallTime: \"\",\n      orderId: null,\n      orderDataInfo: {},\n      activeRadio: 1,\n      payMethodList: [\"微信支付\"],\n      times: null,\n      imgUrl: null,\n    };\n  },\n  created() {\n    this.orderDataInfo = this.orderData();\n  },\n  mounted() {\n    this.runTimeBack();\n  },\n  onLoad(options) {\n    this.orderId = options.orderId;\n  },\n  methods: {\n    ...mapState([\"orderData\", \"shopInfo\"]),\n    //打开弹出层\n    open(){\n        // 通过组件定义的ref调用uni-popup方法 ,如果传入参数 ，type 属性将失效 ，仅支持 ['top','left','bottom','right','center']\n        this.$refs.popup.open('center')\n      },\n    //关闭弹出层\n    close(){\n        this.$refs.popup.close()\n      },\n\n    handleChange(e){\n        console.log(e);\n        this.activeRadio = Number(e.detail.value)+1;\n    },\n    // 支付详情\n    handleSave() {\n      if (this.timeout) {\n        cancelOrder(this.orderId).then((res) => {});\n        uni.redirectTo({\n          url: \"/pages/details/index?orderId=\" + this.orderId,\n        });\n      } else {\n        // 如果支付成功进入成功页\n        clearTimeout(this.times);\n        const params = {\n          orderNumber: this.orderDataInfo.orderNumber,\n          payMethod: this.activeRadio,\n        };\n        paymentOrder(params).then(async (res) => {\n          if (res.code === 1) {\n            if(this.activeRadio===1){\n              // const [err, payRes] = await uni.requestPayment({\n            //   ...res.data,\n            //   package: res.data.packageStr, // package 为微信支付必须的字段\n            // });\n            // console.log(err, payRes);\n            // if (err) {\n            //   await uni.showToast({ title: \"支付失败\", icon: \"error\" });\n            //   setTimeout(() => {\n            //     // 下单失败!!\n            //     uni.redirectTo({\n            //       url: \"/pages/details/index?orderId=\" + this.orderId,\n            //     });\n            //   }, 1500);\n            // } else {\n            //   await uni.showToast({ title: \"支付成功\", icon: \"success\" });\n            //   setTimeout(() => {\n            //     // 下单成功!!\n            //     uni.redirectTo({\n            //       url: \"/pages/success/index?orderId=\" + this.orderId,\n            //     });\n            //   }, 1500);\n            // }\n            console.log('支付成功!')\n            await uni.showToast({ title: \"支付成功\", icon: \"success\" });\n              setTimeout(() => {\n                // 下单成功!!\n                uni.redirectTo({\n                  url: \"/pages/success/index?orderId=\" + this.orderId,\n                });\n              }, 1500);\n            }else{\n              this.imgUrl=res.data.qrcode;\n              this.open();\n            }\n            \n          } else {\n            console.log('支付失败!')\n            uni.showToast({\n              title: res.msg,\n              duration: 1000,\n              icon: \"error\",\n            });\n          }\n        });\n      }\n    },\n    //授权并保存相册\n    saveQRcode(){\n    uni.getSetting({\n      success:(res)=>{\n        if(res.authSetting['scope.writePhotosAlbum']){ //验证用户是否授权可以访问相册\n          this.saveQRcodeToPhotosAlbum();\n        }else{\n          uni.authorize({\n            scope:'scope.writePhotosAlbum',\n            success:(res)=>{\n              console.log('有授权的信息：',res);\n              this.saveQRcodeToPhotosAlbum();\n            },\n            fail:(err)=>{ //取消授权后再获取授权，需手动设置\n              uni.showModal({\n                content:'检测到你没打开保存相册权限，是否去设置打开',\n                confirmText:'确认',\n                cancelText:'取消',\n                success(res){\n                  if(res.confirm){\n                    uni.openSetting({\n                      success(res) {\n                        console.log('授权成功');\n                      }\n                    })\n                  }else{\n                    console.log('取消授权');\n                  }\n                }\n              })\n            }\n          })\n        }\n      }\n    })\n  },\n\n\n// 保存 base64 图片到相册\nsaveQRcodeToPhotosAlbum() {\n  let that = this\n  const path = `${wx.env.USER_DATA_PATH}/qrcode.png`; // 指定图片的临时路径\n  const fsm = wx.getFileSystemManager(); // 获取小程序的文件系统\n  // 把数据写入到临时目录中\n  fsm.writeFile({\n    filePath: path,\n    data: that.imgUrl.replace(/^data:image\\/\\w+;base64,/, ''),\n    encoding: 'base64',\n    success: () => {\n       uni.saveImageToPhotosAlbum({\n              filePath: path,\n              success(res) {\n                uni.showToast({\n                title:'保存成功',\n                icon:'success'\n              })\n            that.close()\n          },\n          fail(err){\n            console.log(err);\n          }\n        })\n    }\n  })\n},\n\n//查询支付结果\nselectResult() {\n    queryOrdersStatus().then((res) => {\n        if (res.code === 1) {\n          uni.showToast({ title: \"支付成功\", icon: \"success\" });\n          setTimeout(() => {\n            uni.redirectTo({\n              url: \"/pages/success/index?orderId=\" + this.orderId,\n            });\n          }, 1500);\n        } else if (res.code === 0 && res.msg === \"订单未付款\") {\n          uni.showToast({\n            title: res.msg,\n            duration: 1000,\n            icon: \"error\",\n          });\n        } else {\n          // 处理其他错误情况\n          uni.showToast({\n            title: \"请求失败，请稍后重试\",\n            icon: \"none\",\n          });\n        }\n      })\n},\n\n\n\n    // // 订单倒计时\n    runTimeBack() {\n      const end = Date.parse(this.orderDataInfo.orderTime.replace(/-/g, \"/\"));\n      const now = Date.parse(new Date());\n      const m15 = 15 * 60 * 1000;\n      const msec = m15 - (now - end);\n      if (msec < 0) {\n        this.timeout = true;\n        clearTimeout(this.times);\n      } else {\n        let min = parseInt((msec / 1000 / 60) % 60);\n        let sec = parseInt((msec / 1000) % 60);\n        if (min < 10) {\n          min = \"0\" + min;\n        } else {\n          min = min;\n        }\n        if (sec < 10) {\n          sec = \"0\" + sec;\n        } else {\n          sec = sec;\n        }\n        this.rocallTime = min + \":\" + sec;\n        let that = this;\n        if (min >= 0 && sec >= 0) {\n          if (min === 0 && sec === 0) {\n            this.timeout = true;\n            clearTimeout(this.times);\n            return;\n          }\n          this.times = setTimeout(function () {\n            that.runTimeBack();\n          }, 1000);\n        }\n      }\n    },\n  },\n};\n</script>\n<style src=\"./../common/Navbar/navbar.scss\" lang=\"scss\" scoped></style>\n<style src=\"./../order/style.scss\" lang=\"scss\"></style>\n<style>\n</style>\n"],"sourceRoot":""}